<!DOCTYPE html>
<html lang="en">
<head>
  <meta charset="UTF-8">
  <meta http-equiv="X-UA-Compatible" content="ie=edge">
  <meta name="viewport" content="width=device-width, initial-scale=1.0, maximum-scale=1.0, minimum-scale=1.0">
  <title>安装软件</title>
</head>
<body>
    <div style="text-align:center;margin-top:80px;">
        <img id="icon" style="width:100px;height:100px;"/>
    </div>
    
    <div style="text-align:center;color:#969799;font-size:14px;font-family:PingFangSC-Regular;">
        <p id="title" style="width:100%"></p>
        <p id="info" style="width:100%"></p>
        <p id="agent" style="width:100%"></p>
    </div>
    
    <div style="text-align:center;font-family:PingFangSC-Regular;font-size:16px;" id="install">
        <button style="background:#3B414D;color:#ffffff;" onclick="install()">
            点击安装
        </button>
    </div>
    
    <div style="text-align:center;color:#969799;font-size:14px;font-family:PingFangSC-Regular;">
        <p id="response" style="width:100%"></p>
    </div>

</body>
<script src="3rd/xml2json/xml2json.min.js"></script>
<script src="3rd/query/parse.js"></script>
<script>
    var manifestURL = "https://39.105.188.157/anbida/manifest.plist"
    var appURL = null
    var platform = 0
            
    document.addEventListener("readystatechange", function (e) {
        if (e.target.readyState === 'complete') {
            loadDevice();
            loadInfo()
        }
    })

    function loadDevice() {
        var userAgent = navigator.userAgent
        if (userAgent.indexOf('iPhone') != -1)
        {
            platform = 1
        }
        else if (userAgent.indexOf('Android') != -1)
        {
            platform = 2
        }
        else
        {
            platform = 3
        }
    }

    function loadInfo() {
        try {
            var xhttp = new XMLHttpRequest()
            xhttp.open("GET", manifestURL, true)
            xhttp.onreadystatechange = function() {
              if (xhttp.readyState == 4){
                  console.log(xhttp.status + '|' + xhttp.responseText)
                  if (xhttp.status == 200){
                      loadAppInfo(xhttp.responseText)
                  }
              }
            };
            xhttp.send(null)
            
        }
        catch (e) {
        
            document.getElementById("response").innerText = e
        }
    }

    function loadAppInfo(resp) {
        var domParser = new DOMParser()
        var xmlDoc = domParser.parseFromString(resp, 'text/xml')

        var x2js = new X2JS();
        var jsonObj = x2js.xml2json(xmlDoc);
        
        var assetsRoot = jsonObj.plist.dict.array.dict;
        var assets = assetsRoot.array
        var meta = assetsRoot.dict
        
        var assetVars = {}
        for (var i in assets.dict) {
            var kindVal = assets.dict[i].string[0]
            var urlVal = assets.dict[i].string[1]
            assetVars[kindVal] = urlVal
        }
        for (var j in meta.key) {
            var metaKey = meta.key[j]
            var metaVal = meta.string[j]
            assetVars[metaKey] = metaVal
        }
                
        console.log(assetVars);
                
        var icon = assetVars["display-image"]
        var name = assetVars["title"]
        var version = assetVars["bundle-version"]
        var bundleId = assetVars["bundle-identifier"]
        var software = assetVars["software-package"]
        
        document.getElementById("icon").src = icon
        document.getElementById("title").innerText = name
        document.getElementById("info").innerText = "版本:" + version + "  " + "bundle-id:" + bundleId
                        
        var userAgent = navigator.userAgent
        document.getElementById("agent").innerText = userAgent
        
        appURL = software
    }

    function install() {
        document.getElementById("install").style.display = "none"
        var showClosure = function() {
            document.getElementById("install").style.display = "block"
        };
        setTimeout(showClosure, 3000)
                
        if (platform == 1)
        {
            window.location.href = "itms-services://?action=download-manifest&url=" + manifest
        }
        else if (platform == 2)
        {
            window.location.href = appURL
        }
        else
        {
            console.log('sorry 目前仅支持 ios与android');
        }
    }
</script>
</html>
